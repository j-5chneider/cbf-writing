---
title: "Reproducible documentation of analyses"
subtitle: "Does Computer-Based Feedback Enhance Revision Performance in Writing Non-Fictional Texts? A Meta-Analysis"
author:
  - name: "[blinded]"
    email: ""
    affiliation: "[blinded]"
    correspondence: true
date: "`r Sys.Date()`" # inserts the date of compiling
editor: source
execute:
  echo: true
  warning: false
  message: false
  cache: false # true will prevent embed-resources
format: 
  html:
    theme: solar
    fontsize: 0.85em
    toc: true
    toc-location: left
    toc-depth: 3
    embed-resources: true # will make standalone html file
    code-fold: true
    code-tools: true
    code-link: true
---

::: callout-tip
## Display code

We folded the code for better readability.  
You can display the code of our analyses

1. by clicking on "Code" > "Show All Code" in the top right corner or
2. by clicking in "Code" in each section of the document individually

:::




```{r}
library(tidyverse)
library(here)
library(haven)
library(metafor)
library(kableExtra)
library(xfun)
library(rio)
library(broom)
```


# Import Data Sets

Two data sets were used:

* Data set "dataN35_prepost": studies with pre-post design
* Data set "dataN15_control": studies with pre-post-control design

Download the data (embeded in this HTML file):

* `r xfun::embed_file(here("02_data/05_major revision/dataN35_prepost.sav"), text = "Download dataN35_prepost")`
* `r xfun::embed_file(here("02_data/05_major revision/dataN15_control.sav"), text = "Download dataN15_control")`

```{r import}
# Load data ----------------------------------------------------------------------
## Data set: studies with pre-post design
data_pp<-read_sav(here("02_data/05_major revision/dataN35_prepost.sav"))

## Data set: studies with pre-post-control design
data_c<-read_sav(here("02_data/05_major revision/dataN15_control.sav"))
```

```{r}
# Prepare data set
data_pp <- data_pp %>%
  mutate(id = 1:35)

data_c <- data_c %>%
  mutate(id = 1:15)
```

# Pre-Post comparison (without control)
## Meta-analytic effect

As we did not find the pre-post test correlation reported in any of the studies, we ran a sensitivity analysis.  
  
One of the studies with control group design provided open data (Burkhart et al., 2020) so that we were able to calculate its pre-post-test correlations (r = .72), which we used as an anchor for the sensitivity analysis.  
  
We included a broad range of 26 (conservative) plausible values in the sensitivity analyses with correlations from r= .50 - .75, using steps of .01.  
  
**This will produce results from 26 meta-analyses.** By the variation of results, we are able to estimate the robustness of our analyses.

```{r loop first meta analysis}
# Establish empty data frame to be filled with results
sensitivity <- data.frame(ri_t = as.numeric(),   # assumed pre-post correlation
                          beta = as.numeric(),   # meta-analytic ES
                          pvalue = as.numeric(), # p value of ES
                          se = as.numeric(),     # SE of meta-analytic ES
                          sigma2 = as.numeric(),   # Tau squared
                          yi.f01 = as.numeric(), # ES of individual studies
                          yi.f02 = as.numeric(),
                          yi.f03 = as.numeric(),
                          yi.f04 = as.numeric(),
                          yi.f05 = as.numeric(),
                          yi.f06 = as.numeric(),
                          yi.f07 = as.numeric(),
                          yi.f08 = as.numeric(),
                          yi.f09 = as.numeric(),
                          yi.f10 = as.numeric(),
                          yi.f11 = as.numeric(),
                          yi.f12 = as.numeric(),
                          yi.f13 = as.numeric(),
                          yi.f14 = as.numeric(),
                          yi.f15 = as.numeric(),
                          yi.f16 = as.numeric(),
                          yi.f17 = as.numeric(),
                          yi.f18 = as.numeric(),
                          yi.f19 = as.numeric(),
                          yi.f20 = as.numeric(),
                          yi.f21 = as.numeric(),
                          yi.f22 = as.numeric(),
                          yi.f23 = as.numeric(),
                          yi.f24 = as.numeric(),
                          yi.f25 = as.numeric(),
                          yi.f26 = as.numeric(),
                          yi.f27 = as.numeric(),
                          yi.f28 = as.numeric(),
                          yi.f29 = as.numeric(),
                          yi.f30 = as.numeric(),
                          yi.f31 = as.numeric(),
                          yi.f32 = as.numeric(),
                          yi.f33 = as.numeric(),
                          yi.f34 = as.numeric(),
                          yi.f35 = as.numeric(),
                          sei.f01 = as.numeric(),  # SEs of ES of individual studies
                          sei.f02 = as.numeric(),
                          sei.f03 = as.numeric(),
                          sei.f04 = as.numeric(),
                          sei.f05 = as.numeric(),
                          sei.f06 = as.numeric(),
                          sei.f07 = as.numeric(),
                          sei.f08 = as.numeric(),
                          sei.f09 = as.numeric(),
                          sei.f10 = as.numeric(),
                          sei.f11 = as.numeric(),
                          sei.f12 = as.numeric(),
                          sei.f13 = as.numeric(),
                          sei.f14 = as.numeric(),
                          sei.f15 = as.numeric(),
                          sei.f16 = as.numeric(),
                          sei.f17 = as.numeric(),
                          sei.f18 = as.numeric(),
                          sei.f19 = as.numeric(),
                          sei.f20 = as.numeric(),
                          sei.f21 = as.numeric(),
                          sei.f22 = as.numeric(),
                          sei.f23 = as.numeric(),
                          sei.f24 = as.numeric(),
                          sei.f25 = as.numeric(),
                          sei.f26 = as.numeric(),
                          sei.f27 = as.numeric(),
                          sei.f28 = as.numeric(),
                          sei.f29 = as.numeric(),
                          sei.f30 = as.numeric(),
                          sei.f31 = as.numeric(),
                          sei.f32 = as.numeric(),
                          sei.f33 = as.numeric(),
                          sei.f34 = as.numeric(),
                          sei.f35 = as.numeric()
)

# starting loop over 26 possible pre-post-correlations
for (ri_t in seq(from = .50, to=.75, by=.01)) {
  ###compute effect sizes for writing quality
  # effect sizes from within-subjects data
  data_pp_es <- escalc(measure = "SMCR",
                       m1i=M_post, m2i=M_pre,
                       sd1i=SD_post, sd2i=SD_pre,
                       ni=N, ri=rep(ri_t, 35), data = data_pp)
  # append the id variable
  data_pp_es$author <- data_pp$author
  data_pp_es$id <- data_pp$id
  
  # compute the meta-analysis
  rma_overall_clustered <- rma.mv(yi = yi,
                                  V = vi, 
                                  data=data_pp_es, 
                                  random = ~ 1 | author, # take clustered data into account
                                  method = "REML",
                                  digits = 3
                                  )
  
  # save estimates for sensitivity analysis
  sensitivity <- sensitivity %>%
    add_row(ri_t = ri_t, 
            pvalue = rma_overall_clustered$pval,
            beta = rma_overall_clustered$beta[,1],
            se = rma_overall_clustered$se[1],
            sigma2 = rma_overall_clustered$sigma2[1],
            yi.f01 = rma_overall_clustered$yi.f[1],
            yi.f02 = rma_overall_clustered$yi.f[2],
            yi.f03 = rma_overall_clustered$yi.f[3],
            yi.f04 = rma_overall_clustered$yi.f[4],
            yi.f05 = rma_overall_clustered$yi.f[5],
            yi.f06 = rma_overall_clustered$yi.f[6],
            yi.f07 = rma_overall_clustered$yi.f[7],
            yi.f08 = rma_overall_clustered$yi.f[8],
            yi.f09 = rma_overall_clustered$yi.f[9],
            yi.f10 = rma_overall_clustered$yi.f[10],
            yi.f11 = rma_overall_clustered$yi.f[11],
            yi.f12 = rma_overall_clustered$yi.f[12],
            yi.f13 = rma_overall_clustered$yi.f[13],
            yi.f14 = rma_overall_clustered$yi.f[14],
            yi.f15 = rma_overall_clustered$yi.f[15],
            yi.f16 = rma_overall_clustered$yi.f[16],
            yi.f17 = rma_overall_clustered$yi.f[17],
            yi.f18 = rma_overall_clustered$yi.f[18],
            yi.f19 = rma_overall_clustered$yi.f[19],
            yi.f20 = rma_overall_clustered$yi.f[20],
            yi.f21 = rma_overall_clustered$yi.f[21],
            yi.f22 = rma_overall_clustered$yi.f[22],
            yi.f23 = rma_overall_clustered$yi.f[23],
            yi.f24 = rma_overall_clustered$yi.f[24],
            yi.f25 = rma_overall_clustered$yi.f[25],
            yi.f26 = rma_overall_clustered$yi.f[26],
            yi.f27 = rma_overall_clustered$yi.f[27],
            yi.f28 = rma_overall_clustered$yi.f[28],
            yi.f29 = rma_overall_clustered$yi.f[29],
            yi.f30 = rma_overall_clustered$yi.f[30],
            yi.f31 = rma_overall_clustered$yi.f[31],
            yi.f32 = rma_overall_clustered$yi.f[32],
            yi.f33 = rma_overall_clustered$yi.f[33],
            yi.f34 = rma_overall_clustered$yi.f[34],
            yi.f35 = rma_overall_clustered$yi.f[35],
            sei.f01 = sqrt(data_pp_es$vi[1]),
            sei.f02 = sqrt(data_pp_es$vi[2]),
            sei.f03 = sqrt(data_pp_es$vi[3]),
            sei.f04 = sqrt(data_pp_es$vi[4]),
            sei.f05 = sqrt(data_pp_es$vi[5]),
            sei.f06 = sqrt(data_pp_es$vi[6]),
            sei.f07 = sqrt(data_pp_es$vi[7]),
            sei.f08 = sqrt(data_pp_es$vi[8]),
            sei.f09 = sqrt(data_pp_es$vi[9]),
            sei.f10 = sqrt(data_pp_es$vi[10]),
            sei.f11 = sqrt(data_pp_es$vi[11]),
            sei.f12 = sqrt(data_pp_es$vi[12]),
            sei.f13 = sqrt(data_pp_es$vi[13]),
            sei.f14 = sqrt(data_pp_es$vi[14]),
            sei.f15 = sqrt(data_pp_es$vi[15]),
            sei.f16 = sqrt(data_pp_es$vi[16]),
            sei.f17 = sqrt(data_pp_es$vi[17]),
            sei.f18 = sqrt(data_pp_es$vi[18]),
            sei.f19 = sqrt(data_pp_es$vi[19]),
            sei.f20 = sqrt(data_pp_es$vi[20]),
            sei.f21 = sqrt(data_pp_es$vi[21]),
            sei.f22 = sqrt(data_pp_es$vi[22]),
            sei.f23 = sqrt(data_pp_es$vi[23]),
            sei.f24 = sqrt(data_pp_es$vi[24]),
            sei.f25 = sqrt(data_pp_es$vi[25]),
            sei.f26 = sqrt(data_pp_es$vi[26]),
            sei.f27 = sqrt(data_pp_es$vi[27]),
            sei.f28 = sqrt(data_pp_es$vi[28]),
            sei.f29 = sqrt(data_pp_es$vi[29]),
            sei.f30 = sqrt(data_pp_es$vi[30]),
            sei.f31 = sqrt(data_pp_es$vi[31]),
            sei.f32 = sqrt(data_pp_es$vi[32]),
            sei.f33 = sqrt(data_pp_es$vi[33]),
            sei.f34 = sqrt(data_pp_es$vi[34]),
            sei.f35 = sqrt(data_pp_es$vi[35])
    )
}
```

### Overview of meta-analytic ES

**Results from all 26 meta-analyses:**

* ri_t: assumed pre-post-correlation
* beta: meta-analytic ES
* se: SE of meta-analytic ES
* pvalue: p value of meta-analytic ES

```{r}
sensitivity %>%
  dplyr::select(ri_t, beta, se, pvalue, sigma2) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

\
\

**We summarize these results:**

* ES_mean: meta-analytic ES (mean over the 26 meta-analyses)
* ES_min: meta-analytic ES (min of the 26 meta-analyses)
* ES_max: meta-analytic ES (max of the 26 meta-analyses)
* CI_lower_mean: lower CI of meta-analytic ES (mean over the 26 meta-analyses)
* CI_lower_min: lower CI of meta-analytic ES (min of the 26 meta-analyses)
* CI_lower_max: lower CI of meta-analytic ES (max of the 26 meta-analyses)
* CI_upper_mean: upper CI of meta-analytic ES (mean over the 26 meta-analyses)
* CI_upper_min: upper CI of meta-analytic ES (min of the 26 meta-analyses)
* CI_upper_max: upper CI of meta-analytic ES (max of the 26 meta-analyses)
* pvalue_mean: p value of meta-analytic ES (mean over the 26 meta-analyses)
* pvalue_min: p value of meta-analytic ES (min of the 26 meta-analyses)
* pvalue_max: p value of meta-analytic ES (max of the 26 meta-analyses)


```{r}
# compute mean, min and max of ES, CI and pvalue from meta-analysis
sensitivity %>%
  dplyr::summarise(ES_mean = mean(beta),
                   ES_min  = min(beta),
                   ES_max  = max(beta),
                   CI_lower_mean = mean(beta-(1.96*se)),
                   CI_lower_min = min(beta-(1.96*se)),
                   CI_lower_max = max(beta-(1.96*se)),
                   CI_upper_mean = mean(beta+(1.96*se)),
                   CI_upper_min = min(beta+(1.96*se)),
                   CI_upper_max = max(beta+(1.96*se)),
                   pvalue_mean = mean(pvalue),
                   pvalue_min = min(pvalue),
                   pvalue_max = max(pvalue),
                   sigma2_mean = mean(sigma2)) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, background = "#C74A48") %>%
  column_spec(2, background = "#B54341") %>%
  column_spec(3, background = "#913634") %>%
  column_spec(4, background = "#27A357") %>%
  column_spec(5, background = "#208748") %>%
  column_spec(6, background = "#186636") %>%
  column_spec(7, background = "#B244B8") %>%
  column_spec(8, background = "#8A358F") %>%
  column_spec(9, background = "#6A296E") %>%
  column_spec(10, background = "#9E8A47") %>%
  column_spec(11, background = "#8F7C40") %>%
  column_spec(12, background = "#6E6031")
```

\
\

**We summarize the same aspects for all 35 studies:**  

```{r}

# compute mean, min and max of ES and CI from each study
sensitivity %>%
  dplyr::select(-c(beta, pvalue, se, sigma2)) %>%
  pivot_longer(c(2:71),                       # reshape data from
               names_to = "variable",         # sensitivity analysis
               values_to = "values") %>%
  mutate(id = as.numeric(str_sub(variable, -2, -1)),
         variable = str_sub(variable, 1, -5)) %>%
  pivot_wider(id_cols = c(id, ri_t), 
              names_from = "variable", 
              values_from = "values") %>%
  group_by(id) %>%
  dplyr::summarise(ES = mean(yi),
                   CI_lower_mean = mean(yi-(1.96*sei)),
                   CI_lower_min  = min(yi-(1.96*sei)),
                   CI_lower_max  = max(yi-(1.96*sei)),
                   CI_upper_mean = mean(yi+(1.96*sei)),
                   CI_upper_min  = min(yi+(1.96*sei)),
                   CI_upper_max  = max(yi+(1.96*sei)))  %>%
  right_join(data_pp[c("id", "author")],., by = "id") %>%
  dplyr::select(-id) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(2, background = "#C74A48") %>%
  column_spec(3, background = "#27A357") %>%
  column_spec(4, background = "#208748") %>%
  column_spec(5, background = "#186636") %>%
  column_spec(6, background = "#B244B8") %>%
  column_spec(7, background = "#8A358F") %>%
  column_spec(8, background = "#6A296E")
```


### Forest Plot

In order to be able to display a forest plot, we calculated a meta-analysis with the mean assumed pre-post-correlation (r=.625).

```{r}
#| fig-width: 12
#| fig-height: 11

## FOREST PLOT with mean correlation
###compute effect sizes for writing quality
# effect sizes from within-subjects data
data_pp_es <- escalc(measure = "SMCR",
                     m1i=data_pp$M_post, m2i=data_pp$M_pre,
                     sd1i=data_pp$SD_post, sd2i=data_pp$SD_pre,
                     ni=data_pp$N, ri=rep(.625, 35),
                     slab = data_pp$author)
# append the author and id variable
data_pp_es$author <- data_pp$author
data_pp_es$id <- data_pp$id

REM <- rma.mv(yi = yi,
              V = vi, 
              data=data_pp_es, 
              random = ~ 1 | author,
              method = "REML",
              digits = 3)

###FOREST PLOT
forest(REM)

```

### Fitting models

Model 1 without cluster vs. Model 2 clustered for author. Better fit for Model 2.

```{r}

model1 <- rma.mv(
  yi = yi, 
  V = vi, 
  data = data_pp_es,
  method = "REML")

model2 <- rma.mv(
  yi = yi, 
  V = vi, 
  data = data_pp_es,
  random = ~ 1 | author,
  method = "REML")

modelfit<-anova(model1, model2)
modelfit #better fit for model 2

##Robust variance estimation
# RVE without cluster (dummy coded)
robust(REM, cluster = id)

# RVE for author clustered:
robust(REM, cluster = author)

```

## Bias estimation

### Funnel plot

```{r}

funnel(REM, legend = T)
```

### Trim and fill

```{r}
##Trim & fill
rma_trimfill <- rma(yi, vi, data=data_pp_es) # compute random-effects model without
                                             # clustering, as trimfill() can't handle
                                             # these objects
taf_overall <- trimfill(rma_trimfill)
taf_overall 

funnel(taf_overall, legend = T)
```

### Egger's test

```{r}

regtest(rma_trimfill)
```


## Moderators

For reasons of clarity, we will report results from the moderation analyses based on the meta-analysis with the mean correlation of r = .625 as the ES does not vary due to different pre-post-correlation.


### Create functions for moderation analyses
```{r}
r_prepost <- 0.625 

fn_meta_pre_post <- function(moderator, cor, data_pp_es) {
data_pp_es <- data_pp_es %>%
  mutate(r = cor)

data_pp_es <- escalc(
    measure = "SMCR",
    m1i = M_post, 
    sd1i = SD_post, 
    m2i = M_pre, 
    sd2i = SD_pre, 
    ni = N, 
    ri = r,
    data = data_pp_es
  )

V <- vcalc(vi = vi, cluster = author, subgroup = group, data = data_pp_es)

REM <- rma.mv(
    yi = yi, 
    V = V, 
    data = data_pp_es,
    mods = as.formula(paste("~ factor(", moderator, ") - 1")),
    random = ~ 1 | author,
    method = "REML",
    digits = 2,
    test = "t",
    dfs = "contain")

  return(summary(REM))
}

# Q-tests
fn_meta_qtest<- function(moderator, cor, data_pp_es){
  REM <- fn_meta_pre_post(moderator, cor, data_pp_es)
  q_extract <- data.frame(
    qe_value = format(round(REM$QE, 3), nsmall = 2),
    qe_df = REM$QEdf,
    qe_p = format(round(REM$QEp, 3), nsmall = 3),
    f_value = format(round(REM$QM, 3), nsmall = 2),
    f_df1 = REM$QMdf[1],
    f_df2 = REM$QMdf[2],
    f_p = format(round(REM$QMp, 3), nsmall = 3))
  
  q_results <- q_extract %>%
    mutate(moderator = moderator) %>%
    mutate(qe_p = ifelse(qe_p < .001, "< .001", as.character(qe_p))) %>%
    mutate(qe_p = gsub("^0\\.", ".", qe_p)) %>%
    mutate(f_p = ifelse(f_p < .001, "< .001", as.character(f_p))) %>%
    mutate(f_p = gsub("^0\\.", ".", f_p)) %>%
    mutate(qm_statistics = paste0("QE = ", qe_value,
                                  ", df = ", qe_df,
                                  ", p = ", qe_p,
                                  "\nF(", f_df1,
                                  ", ", f_df2,
                                  ") = ", f_value,
                                  ", p = ", f_p),
           .keep = "unused")
}

```

### Moderator analyses
```{r}
# included moderators
moderators <- c("rep_numeric", "rep_graphical", "rep_highlighting", 
  "rep_text_based", "rep_nr", "FB_order", "FB_specificity", 
  "order_outcome", "rank_wq", "reliability_measurement", "treatment_fidelity", 
  "writing_tests", "post_measure", "experiment", 
  "validated_tool", "ceiling_or_flooring_effect", 
  "FB_tool_numbers", "manuscript_type", "education_dummy", 
  "setting", "country", "genre", "amount",
  "coding", "system_type", "teacher_effects"
)


# Run moderator analysis
results_moderation <- data.frame()

for (mod in moderators) {
  result <- fn_meta_pre_post(moderator = mod, cor = r_prepost, data_pp_es = data_pp) %>% broom::tidy()
  result$moderator <- mod
  results_moderation <- bind_rows(results_moderation, result)
}


# Q-Test results 
qtest_results_moderation <- data.frame()

# Loop through each moderator
for (mod in moderators) {
  qtest <- fn_meta_qtest(moderator = mod, cor = r_prepost, data_pp_es = data_pp)
  qtest_results_moderation <- rbind(qtest_results_moderation, data.frame(moderator = mod, q_test = qtest))}
  
# Customize dataset -------------------------------------------------------
number_of_effects <- data_pp_es %>%
  dplyr::select(any_of(moderators)) %>%
  pivot_longer(everything(), names_to = "moderator", 
               values_to = "term", values_transform = as.character) %>%
  count(moderator, term, name = "k")

descriptive_data <- data_pp_es %>%
  dplyr::select(N, any_of(moderators)) %>%
  pivot_longer(-N, names_to = "moderator", 
               values_to = "term", values_transform = as.character) %>%
  group_by(moderator, term) %>%
  summarize(N = sum(N)) %>%
  left_join(., number_of_effects, by = c("moderator", "term"))
  
prepost_final <- results_moderation %>%
  mutate(term = str_remove(term, "^[^)]*\\)")) %>%
  mutate(sig = case_when(
    p.value < .001 ~ "***",
    p.value < .01 ~ "**",
    p.value < .05 ~ "*",
    TRUE ~ "ns"
  )) %>%
  mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  mutate(across(where(is.numeric), ~ format(.x, nsmall = 3)))%>%
  mutate(p.value = ifelse(p.value < .001, "< .001", as.character(p.value))) %>%
  mutate(p.value = gsub("^0\\.", ".", p.value)) %>%
  left_join(., descriptive_data, by = c("moderator", "term")) %>%
  select(moderator, term, sig, k, N, estimate, std.error, statistic, p.value) %>%
  mutate(moderator = if_else(duplicated(moderator), NA_character_, moderator)) %>%
  left_join(., qtest_results_moderation, by = "moderator") %>%
  select(-q_test.moderator)


# Post-hoc tests -------------------------------------------------
generate_contrast_matrix <- function(p) {
  if (p < 2) stop("p must be at least 2.")
  
  # Initialize an empty list to store rows
  contrast_list <- list()
  
  # Loop through all pairs of coefficients (i, j)
  for (i in 1:(p-1)) {
    for (j in (i+1):p) {
      contrast <- rep(0, p)  # Initialize a row of zeros
      contrast[i] <- -1      # Contrast for the i-th coefficient
      contrast[j] <- 1       # Contrast for the j-th coefficient
      contrast_list <- append(contrast_list, list(contrast))
    }
  }
  
  contrast_matrix <- do.call(rbind, contrast_list)
  return(contrast_matrix)
}


results_posthoc <- data.frame()

for (mod in moderators) {
  result <- fn_meta_pre_post(moderator = mod, cor = r_prepost, data = data_pp_es)
  result_posthoc <- result %>% broom::tidy()
  result_posthoc$moderator <- mod
  contrast_matrix <- generate_contrast_matrix(result$p)
  anova_result <- data.frame(anova(result, X = contrast_matrix))
  results_posthoc <- bind_rows(results_posthoc, anova_result)
}


```




# Pre-Post-Control comparison

## Meta-analytic effect

In this section, we used the same approach via sensitivity analyses as above.


```{r loop second meta analysis}
sensitivity <- data.frame(ri_t = as.numeric(),  # assumed pre-post correlation treatment group
                          ri_c = as.numeric(),  # assumed pre-post correlation control group
                          pvalue = as.numeric(), # p value of ES
                          beta = as.numeric(),   # meta-analytic ES
                          se = as.numeric(),     # SE of meta-analytic ES
                          sigma2 = as.numeric(),   # tau squared
                          yi.f01 = as.numeric(), # ES of individual studies
                          yi.f02 = as.numeric(),
                          yi.f03 = as.numeric(),
                          yi.f04 = as.numeric(),
                          yi.f05 = as.numeric(),
                          yi.f06 = as.numeric(),
                          yi.f07 = as.numeric(),
                          yi.f08 = as.numeric(),
                          yi.f09 = as.numeric(),
                          yi.f10 = as.numeric(),
                          yi.f11 = as.numeric(),
                          yi.f12 = as.numeric(),
                          yi.f13 = as.numeric(),
                          yi.f14 = as.numeric(),
                          yi.f15 = as.numeric(),
                          sei.f01 = as.numeric(),  # SEs of ES of individual studies
                          sei.f02 = as.numeric(),
                          sei.f03 = as.numeric(),
                          sei.f04 = as.numeric(),
                          sei.f05 = as.numeric(),
                          sei.f06 = as.numeric(),
                          sei.f07 = as.numeric(),
                          sei.f08 = as.numeric(),
                          sei.f09 = as.numeric(),
                          sei.f10 = as.numeric(),
                          sei.f11 = as.numeric(),
                          sei.f12 = as.numeric(),
                          sei.f13 = as.numeric(),
                          sei.f14 = as.numeric(),
                          sei.f15 = as.numeric()
                          )

for (ri_t in seq(from = .50, to=.75, by=.01)) {
  ###compute effect sizes for writing quality
  # effect sizes from between-subjects data
    dat_es_exp <- escalc(measure = "SMCR",
                     m1i = M_Feedback2,
                     m2i = M_Feedback,
                     sd1i = SD_Feedback2,
                     sd2i = SD_Feedback,
                     ni= N_Feedback,
                     ri=rep(ri_t, 15),
                     slab = author,
                     data = data_c)
    
    dat_es_con <- escalc(measure = "SMCR",
                     m1i = M_NoFeedback2,
                     m2i = M_NoFeedback,
                     sd1i = SD_NoFeedback2,
                     sd2i = SD_NoFeedback,
                     ni = N_noFeedback,
                     ri= rep((ri_t+.14), 15),
                     slab = author,
                     data = data_c)
  
  
  dat <- data_c %>%
  mutate(yi = dat_es_exp$yi - dat_es_con$yi,
         vi = dat_es_exp$vi + dat_es_con$vi)
  
  rma_overall_clustered <- rma.mv(
  yi = yi, 
  V = vi, 
  data = dat,
  random = ~ 1 | author,
  method = "REML",
  digits = 3
)
  
  sensitivity <- sensitivity %>%
    add_row(ri_t = ri_t, 
            ri_c = (ri_t+.14),
            pvalue = rma_overall_clustered$pval,
            beta = rma_overall_clustered$beta[,1],
            se = rma_overall_clustered$se[1],
            sigma2 = rma_overall_clustered$sigma2[1],
            yi.f01 = rma_overall_clustered$yi.f[1],
            yi.f02 = rma_overall_clustered$yi.f[2],
            yi.f03 = rma_overall_clustered$yi.f[3],
            yi.f04 = rma_overall_clustered$yi.f[4],
            yi.f05 = rma_overall_clustered$yi.f[5],
            yi.f06 = rma_overall_clustered$yi.f[6],
            yi.f07 = rma_overall_clustered$yi.f[7],
            yi.f08 = rma_overall_clustered$yi.f[8],
            yi.f09 = rma_overall_clustered$yi.f[9],
            yi.f10 = rma_overall_clustered$yi.f[10],
            yi.f11 = rma_overall_clustered$yi.f[11],
            yi.f12 = rma_overall_clustered$yi.f[12],
            yi.f13 = rma_overall_clustered$yi.f[13],
            yi.f14 = rma_overall_clustered$yi.f[14],
            yi.f15 = rma_overall_clustered$yi.f[15],
            sei.f01 = sqrt(dat$vi[1]),
            sei.f02 = sqrt(dat$vi[2]),
            sei.f03 = sqrt(dat$vi[3]),
            sei.f04 = sqrt(dat$vi[4]),
            sei.f05 = sqrt(dat$vi[5]),
            sei.f06 = sqrt(dat$vi[6]),
            sei.f07 = sqrt(dat$vi[7]),
            sei.f08 = sqrt(dat$vi[8]),
            sei.f09 = sqrt(dat$vi[9]),
            sei.f10 = sqrt(dat$vi[10]),
            sei.f11 = sqrt(dat$vi[11]),
            sei.f12 = sqrt(dat$vi[12]),
            sei.f13 = sqrt(dat$vi[13]),
            sei.f14 = sqrt(dat$vi[14]),
            sei.f15 = sqrt(dat$vi[15])
    )
}
```

### Overview of meta-analytic ES

**Results from all 26 meta-analyses:**

* ri_t: assumed pre-post-correlation (treatment group)
* ri_c: assumed pre-post-correlation (control group)
* beta: meta-analytic ES
* se: SE of meta-analytic ES
* pvalue: p value of meta-analytic ES

```{r}
sensitivity %>%
  dplyr::select(ri_t, ri_c, beta, se, pvalue, sigma2) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```


\
\

**We summarize these results:**

* ES_mean: meta-analytic ES (mean over the 26 meta-analyses)
* ES_min: meta-analytic ES (min of the 26 meta-analyses)
* ES_max: meta-analytic ES (max of the 26 meta-analyses)
* CI_lower_mean: lower CI of meta-analytic ES (mean over the 26 meta-analyses)
* CI_lower_min: lower CI of meta-analytic ES (min of the 26 meta-analyses)
* CI_lower_max: lower CI of meta-analytic ES (max of the 26 meta-analyses)
* CI_upper_mean: upper CI of meta-analytic ES (mean over the 26 meta-analyses)
* CI_upper_min: upper CI of meta-analytic ES (min of the 26 meta-analyses)
* CI_upper_max: upper CI of meta-analytic ES (max of the 26 meta-analyses)
* pvalue_mean: p value of meta-analytic ES (mean over the 26 meta-analyses)
* pvalue_min: p value of meta-analytic ES (min of the 26 meta-analyses)
* pvalue_max: p value of meta-analytic ES (max of the 26 meta-analyses)

```{r}
# compute mean, min and max of ES, CI and pvalue from meta-analysis
sensitivity %>%
  dplyr::summarise(ES_mean = mean(beta),
                   ES_min  = min(beta),
                   ES_max  = max(beta),
                   CI_lower_mean        = mean(beta-(1.96*se)),
                   CI_lower_min = min(beta-(1.96*se)),
                   CI_lower_max = max(beta-(1.96*se)),
                   CI_upper_mean        = mean(beta+(1.96*se)),
                   CI_upper_min = min(beta+(1.96*se)),
                   CI_upper_max = max(beta+(1.96*se)),
                   pvalue_mean        = mean(pvalue),
                   pvalue_min = min(pvalue),
                   pvalue_max = max(pvalue),
                   sigma2_mean = mean(sigma2)) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, background = "#C74A48") %>%
  column_spec(2, background = "#B54341") %>%
  column_spec(3, background = "#913634") %>%
  column_spec(4, background = "#27A357") %>%
  column_spec(5, background = "#208748") %>%
  column_spec(6, background = "#186636") %>%
  column_spec(7, background = "#B244B8") %>%
  column_spec(8, background = "#8A358F") %>%
  column_spec(9, background = "#6A296E") %>%
  column_spec(10, background = "#9E8A47") %>%
  column_spec(11, background = "#8F7C40") %>%
  column_spec(12, background = "#6E6031")
```


\
\

**We summarize the same aspects for all 15 studies:**  

```{r}
data_c <- data_c %>%
  mutate(id = 1:15)

# compute mean, min and max of ES and CI from each study
sensitivity %>%
  dplyr::select(-c(beta, pvalue, se, sigma2)) %>%
  pivot_longer(c(3:30),                       # reshape data data from
               names_to = "variable",         # sensitivity analysis
               values_to = "values") %>%
  mutate(id = as.numeric(str_sub(variable, -2, -1)),
         variable = str_sub(variable, 1, -5)) %>%
  pivot_wider(id_cols = c(id, ri_t, ri_c), 
              names_from = "variable", 
              values_from = "values") %>%
  group_by(id) %>%
  dplyr::summarise(ES = mean(yi),    # compute mean, min and max
                   CI_lower_mean = mean(yi-(1.96*sei)),
                   CI_lower_min  = min(yi-(1.96*sei)),
                   CI_lower_max  = max(yi-(1.96*sei)),
                   CI_upper_mean = mean(yi+(1.96*sei)),
                   CI_upper_min  = min(yi+(1.96*sei)),
                   CI_upper_max  = max(yi+(1.96*sei)))  %>%
  right_join(data_c[c("id", "author")],., by = "id") %>%
  dplyr::select(-id) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(2, background = "#C74A48") %>%
  column_spec(3, background = "#27A357") %>%
  column_spec(4, background = "#208748") %>%
  column_spec(5, background = "#186636") %>%
  column_spec(6, background = "#B244B8") %>%
  column_spec(7, background = "#8A358F") %>%
  column_spec(8, background = "#6A296E")
```


### Forest Plot

In order to be able to display a forest plot, we calculated a meta-analysis with the mean assumed pre-post-correlation (r=.625 for the intervention group; r=.765 for the control group).

```{r}
## FOREST PLOT with mean correlation

    dat_es_exp <- escalc(measure = "SMCR",
                     m1i = M_Feedback2,
                     m2i = M_Feedback,
                     sd1i = SD_Feedback2,
                     sd2i = SD_Feedback,
                     ni= N_Feedback,
                     ri=rep(.625, 15),
                     slab = author,
                     data = data_c)
    
    dat_es_con <- escalc(measure = "SMCR",
                     m1i = M_NoFeedback2,
                     m2i = M_NoFeedback,
                     sd1i = SD_NoFeedback2,
                     sd2i = SD_NoFeedback,
                     ni = N_noFeedback,
                     ri= rep(.765, 15),
                     slab = author,
                     data = data_c)

dat <- data_c %>%
  mutate(yi = dat_es_exp$yi - dat_es_con$yi,
         vi = dat_es_exp$vi + dat_es_con$vi)

REM <- rma.mv(
  yi = yi, 
  V = vi, 
  data=dat, 
  random = ~ 1 | author,
  method = "REML",
  digits = 3
)

summary(REM)
###FOREST PLOT
forest(REM)
```

## Fitting models

Model 1 without cluster vs. Model 2 clustered for author. Better fit for Model 2.

```{r}
model1 <- rma.mv(
  yi = yi, 
  V = vi, 
  data = data_c,
  method = "REML")

model2 <- rma.mv(
  yi = yi, 
  V = vi, 
  data = data_c,
  random = ~ 1 | author,
  method = "REML")

anova(model1, model2)
#better fit for model 2

# RVE without cluster (dummy coded)
robust(REM, cluster = id, method = "ClubSandwich")

# RVE for author clustered:
robust(REM, cluster = author)
```


## Bias estimation

### Funnel plot

```{r}
##Funnel plot
funnel(REM, legend = T)
```

### Trim and fill

```{r}
##Trim & fill
rma_trimfill <- rma(yi, vi, data=dat) # compute random-effects model without
                                      # clustering, as trimfill() can't handle
                                      # these objects
taf_overall <- trimfill(rma_trimfill)
taf_overall 

funnel(taf_overall, legend = T)
```

### Egger's test

```{r}
##Egger's test
regtest(rma_trimfill) 
```


## Moderators

For reasons of clarity, we will report results from the moderation analyses based on the meta-analysis with the mean correlations of r_exp = .625 for pre-post and r_control = .765 as the ES does not vary due to different pre-post-correlation.


### Create functions for moderation analyses
```{r}
r_exp <- .625
r_con <- .765

fn_meta_experimental <- function(moderator, cor_exp, cor_con, data_c) {

data_c <- data_c %>%
  mutate(r_exp = cor_exp,
         r_con = cor_con)

dat_es_exp <- escalc(measure = "SMCR",
                     m1i = M_Feedback2,
                     m2i = M_Feedback,
                     sd1i = SD_Feedback2,
                     sd2i = SD_Feedback,
                     ni= N_Feedback,
                     ri=r_exp,
                     slab = author,
                     data = data_c)

dat_es_con <- escalc(measure = "SMCR",
                     m1i = M_NoFeedback2,
                     m2i = M_NoFeedback,
                     sd1i = SD_NoFeedback2,
                     sd2i = SD_NoFeedback,
                     ni = N_noFeedback,
                     ri= r_con,
                     slab = author,
                     data = data_c)

dat <- data_c %>%
  mutate(yi = dat_es_exp$yi - dat_es_con$yi,
         vi = dat_es_exp$vi + dat_es_con$vi)

V <- vcalc(vi = vi, cluster = author, subgroup = group, data = data_c)

REM <- rma.mv(
    yi = yi, 
    V = V, 
    data = data,
    mods = as.formula(paste("~ factor(", moderator, ") - 1")),
    random = ~ 1 | author,
    method = "REML",
    digits = 2,
    test = "t",
    dfs = "contain"
  )

return(summary(REM))
}

#Q-test

fn_meta_qtest<- function(moderator, cor_exp, cor_con, data_c){
  REM <- fn_meta_experimental(moderator, cor_exp, cor_con, data_c)
  q_extract <- data.frame(
    qe_value = format(round(REM$QE, 2), nsmall = 2),
    qe_df = REM$QEdf,
    qe_p = format(round(REM$QEp, 3), nsmall = 3),
    f_value = format(round(REM$QM, 2), nsmall = 2),
    f_df1 = REM$QMdf[1],
    f_df2 = REM$QMdf[2],
    f_p = format(round(REM$QMp, 3), nsmall = 3))
  
  q_results <- q_extract %>%
    mutate(moderator = moderator) %>%
    mutate(qe_p = ifelse(qe_p < 0.001, "< .001", as.character(qe_p))) %>%
    mutate(qe_p = gsub("^0\\.", ".", qe_p)) %>%
    mutate(f_p = ifelse(f_p < 0.001, "< .001", as.character(f_p))) %>%
    mutate(f_p = gsub("^0\\.", ".", f_p)) %>%
    mutate(qm_statistics = paste0("QE = ", qe_value,
                                  ", df = ", qe_df,
                                  ", p = ", qe_p,
                                  "\nF(", f_df1,
                                  ", ", f_df2,
                                  ") = ", f_value,
                                  ", p = ", f_p),
           .keep = "unused")}

```


### Moderation analyses
```{r}

#included moderators
moderators <- c("rep_numeric", "rep_graphical", "rep_highlighting", 
                "rep_text_based", "rep_nr", "FB_order", "FB_specificity", 
                "order_outcome", "reliability_measurement", "treatment_fidelity", 
                "writing_tests", "rank_mean_wq", "post_measure", "experiment", 
                "validated_tool", "ceiling_or_flooring_effect", "pretest_equivalence", 
                "fb_tool_numbers", "manuscript_type", "education_dummy", 
                "setting", "country", "genre", "amount",
                "coding", "system_type", "teacher_effects"
)

# Run moderator analysis
results_moderation <- data.frame()

for (mod in moderators) {
  result <- fn_meta_experimental(moderator = mod, cor_exp = r_exp, cor_con = r_con, data = data_c) %>%
    tidy()
  result$moderator <- mod
  results_moderation <- bind_rows(results_moderation, result)
}

# Test results ------------------------------------------------------------

qtest_results_moderation <- data.frame()

# Loop through each moderator
for (mod in moderators) {
  qtest <- fn_meta_qtest(moderator = mod, cor_exp = r_exp, cor_con = r_con, data = data_c)
  qtest_results_moderation <- rbind(qtest_results_moderation, data.frame(moderator = mod, q_test = qtest))}
  
# Customize dataset -------------------------------------------------------

number_of_effects <- data_c %>%
  select(any_of(moderators)) %>%
  pivot_longer(everything(), names_to = "moderator", values_to = "term") %>%
  count(moderator, term, name = "k")

descriptive_data <- data_c %>%
  select(N_Feedback, N_noFeedback, any_of(moderators)) %>%
  pivot_longer(-c(N_Feedback, N_noFeedback), names_to = "moderator", values_to = "term") %>%
  group_by(moderator, term) %>%
  summarize(n_exp = sum(N_Feedback),
            n_con = sum(N_noFeedback)) %>%
  mutate(n_exp_con = paste0(n_exp, "/", n_con), .keep = "unused") %>%
  left_join(., number_of_effects, by = c("moderator", "term"))
  
experimental_final <- results_df %>%
  mutate(term = str_remove(term, "^[^)]*\\)")) %>%
  mutate(sig = case_when(
    p.value < .001 ~ "***",
    p.value < .01 ~ "**",
    p.value < .05 ~ "*",
    TRUE ~ "ns"
  )) %>%
  mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  mutate(across(where(is.numeric), ~ format(.x, nsmall = 3)))%>%
  mutate(p.value = ifelse(p.value < .001, "< .001", as.character(p.value))) %>%
  mutate(p.value = gsub("^0\\.", ".", p.value)) %>%
  left_join(., descriptive_data, by = c("moderator", "term")) %>%
  select(moderator, term, sig, k, n_exp_con, estimate, std.error, statistic, p.value) %>%
  mutate(moderator = if_else(duplicated(moderator), NA_character_, moderator)) %>%
  left_join(., qtest_results_df, by = "moderator") %>%
  select(-q_test.moderator)

export(experimental_final, "results_exp.xlsx")


# Post-hoc tests -------------------------------------------------

generate_contrast_matrix <- function(p) {
  if (p < 2) stop("p must be at least 2.")
  
  # Initialize an empty list to store rows
  contrast_list <- list()
  
  # Loop through all pairs of coefficients (i, j)
  for (i in 1:(p-1)) {
    for (j in (i+1):p) {
      contrast <- rep(0, p)  # Initialize a row of zeros
      contrast[i] <- -1      # Contrast for the i-th coefficient
      contrast[j] <- 1       # Contrast for the j-th coefficient
      contrast_list <- append(contrast_list, list(contrast))
    }
  }
  
  contrast_matrix <- do.call(rbind, contrast_list)
  return(contrast_matrix)
}


results_posthoc <- data.frame()

for (mod in moderators) {
  result <- fn_meta_experimental(moderator = mod, cor_exp = r_exp, cor_con = r_con, data = df)
  result_posthoc <- result %>% tidy()
  result_posthoc$moderator <- mod
  contrast_matrix <- generate_contrast_matrix(result$p)
  anova_result <- data.frame(anova(result, X = contrast_matrix))
  results_posthoc <- bind_rows(results_posthoc, anova_result)
}

results_posthoc <- results_posthoc %>%
  mutate(
    moderator = str_extract(hyp, "(?<=\\().+?(?=\\))"),
    factor_1 = str_extract(hyp, "(?<=\\))[^+]+(?=\\+)") %>% str_trim(),
    factor_2 = str_extract(hyp, "(?<=\\+)\\s*factor\\(.+?\\)([a-zA-Z]+)") %>% str_replace("^.*\\)", "") %>% str_trim(), .keep = "unused"
  ) %>%
  mutate(sig = case_when(
    pval < 0.001 ~ "***",
    pval < 0.01 ~ "**",
    pval < 0.05 ~ "*",
    TRUE ~ "ns"
  )) %>%
  select(moderator, factor_1, factor_2, sig, everything()) %>%
  mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  mutate(across(where(is.numeric), ~ format(.x, nsmall = 3)))%>%
  mutate(pval = ifelse(pval < 0.001, "< .001", as.character(pval))) %>%
  mutate(pval = gsub("^0\\.", ".", pval))

```

# Computational Environment
R-Version and libraries used.

```{r Session Info}
sessionInfo()
```
